{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.13.1.58284",
      "templateHash": "3968206505888406621"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "uniqueSeed": {
      "type": "string",
      "defaultValue": "[format('{0}-{1}', resourceGroup().id, deployment().name)]"
    }
  },
  "variables": {
    "serviceBusName": "sb11-dev",
    "queueName": "orders",
    "serviceBusQueueName": "[format('{0}/{1}', variables('serviceBusName'), variables('queueName'))]",
    "policyName": "testsaspolicy",
    "containerAppsEnvName": "containerappenv-utob7veruf5g4"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-infra-keyvault', deployment().name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vaultName": {
            "value": "cakv-dev"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "14080578410632927357"
            }
          },
          "parameters": {
            "vaultName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "skuName": {
              "type": "string",
              "defaultValue": "standard"
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2021-11-01-preview",
              "name": "[parameters('vaultName')]",
              "location": "[parameters('location')]",
              "properties": {
                "accessPolicies": [],
                "enableRbacAuthorization": false,
                "enableSoftDelete": false,
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": false,
                "tenantId": "[subscription().tenantId]",
                "sku": {
                  "name": "[parameters('skuName')]",
                  "family": "A"
                },
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            }
          ],
          "outputs": {
            "vaultName": {
              "type": "string",
              "value": "[parameters('vaultName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-infra-servicebus', deployment().name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('serviceBusName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "17356559096437594462"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ServiceBus/namespaces",
              "apiVersion": "2021-06-01-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard",
                "tier": "Standard"
              }
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-01-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), 'orders')]",
              "properties": {
                "defaultMessageTimeToLive": "P6M",
                "status": "Active"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "servicebusId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ServiceBus/namespaces', parameters('name'))]"
            },
            "servicebusName": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "apiVersion": {
              "type": "string",
              "value": "2021-06-01-preview"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-infra-container-app-env', deployment().name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "uniqueSeed": {
            "value": "[parameters('uniqueSeed')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "2661123819529360111"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "uniqueSeed": {
              "type": "string"
            },
            "containerAppsEnvironmentName": {
              "type": "string",
              "defaultValue": "[format('containerappenv-{0}', uniqueString(parameters('uniqueSeed')))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "defaultValue": "[format('loganalytics-{0}', uniqueString(parameters('uniqueSeed')))]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2020-03-01-preview",
              "name": "[parameters('logAnalyticsWorkspaceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "retentionInDays": 30,
                "features": {
                  "searchVersion": 1
                },
                "sku": {
                  "name": "PerGB2018"
                }
              }
            },
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2022-06-01-preview",
              "name": "[parameters('containerAppsEnvironmentName')]",
              "location": "[parameters('location')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2020-03-01-preview').customerId]",
                    "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2020-03-01-preview').primarySharedKey]"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
              ]
            }
          ],
          "outputs": {
            "containerAppsEnvironmentId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('containerAppsEnvironmentName'))]"
            },
            "containerAppsEnvironmentDomain": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('containerAppsEnvironmentName')), '2022-06-01-preview').defaultDomain]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-app-web-api', deployment().name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "containerAppsEnvironmentId": {
            "value": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvName'))]"
          },
          "containerAppsEnvironmentDomain": {
            "value": "[reference(resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvName')), '2022-06-01-preview').defaultDomain]"
          },
          "serviceBusConnectionString": {
            "value": "[format('Endpoint=sb://{0}.servicebus.windows.net/;SharedAccessKeyName={1};SharedAccessKey={2}', variables('serviceBusName'), variables('policyName'), listKeys(format('{0}/AuthorizationRules/{1}', resourceId('Microsoft.ServiceBus/namespaces/queues', split(variables('serviceBusQueueName'), '/')[0], split(variables('serviceBusQueueName'), '/')[1]), variables('policyName')), '2022-01-01-preview').primaryKey)]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "2903865009306261177"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "containerAppsEnvironmentId": {
              "type": "string"
            },
            "containerAppsEnvironmentDomain": {
              "type": "string"
            },
            "serviceBusConnectionString": {
              "type": "secureString"
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2022-06-01-preview",
              "name": "ordering-webapi",
              "location": "[parameters('location')]",
              "properties": {
                "managedEnvironmentId": "[parameters('containerAppsEnvironmentId')]",
                "template": {
                  "containers": [
                    {
                      "name": "ordering-webapi",
                      "image": "aknagar/ordering-webapi:1.0.0",
                      "resources": {
                        "cpu": "[json('0.5')]",
                        "memory": "1.0Gi"
                      },
                      "env": [
                        {
                          "name": "ASPNETCORE_ENVIRONMENT",
                          "value": "Development"
                        },
                        {
                          "name": "ASPNETCORE_URLS",
                          "value": "http://0.0.0.0:80"
                        },
                        {
                          "name": "IdentityUrl",
                          "value": "[format('https://identity-api.{0}', parameters('containerAppsEnvironmentDomain'))]"
                        },
                        {
                          "name": "IdentityUrlExternal",
                          "value": "[format('https://identity-api.{0}', parameters('containerAppsEnvironmentDomain'))]"
                        },
                        {
                          "name": "SERVICEBUS_AUTH_MODE",
                          "value": "ConnectionString"
                        },
                        {
                          "name": "SERVICEBUS_QUEUE_NAME",
                          "value": "orders"
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": 1,
                    "maxReplicas": 1
                  }
                },
                "configuration": {
                  "ingress": {
                    "external": true,
                    "targetPort": 80,
                    "allowInsecure": false,
                    "traffic": [
                      {
                        "latestRevision": true,
                        "weight": 100
                      }
                    ]
                  },
                  "secrets": [
                    {
                      "name": "service-bus-connection-string",
                      "value": "[parameters('serviceBusConnectionString')]"
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-queue-worker', deployment().name)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "containerAppsEnvironmentId": {
            "value": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvName'))]"
          },
          "containerAppsEnvironmentDomain": {
            "value": "[reference(resourceId('Microsoft.App/managedEnvironments', variables('containerAppsEnvName')), '2022-06-01-preview').defaultDomain]"
          },
          "serviceBusConnectionString": {
            "value": "[format('Endpoint=sb://{0}.servicebus.windows.net/;SharedAccessKeyName={1};SharedAccessKey={2};EntityPath={3}', variables('serviceBusName'), variables('policyName'), listKeys(format('{0}/AuthorizationRules/{1}', resourceId('Microsoft.ServiceBus/namespaces/queues', split(variables('serviceBusQueueName'), '/')[0], split(variables('serviceBusQueueName'), '/')[1]), variables('policyName')), '2022-01-01-preview').primaryKey, variables('queueName'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "11197749926586179863"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "containerAppsEnvironmentId": {
              "type": "string"
            },
            "containerAppsEnvironmentDomain": {
              "type": "string"
            },
            "serviceBusConnectionString": {
              "type": "secureString"
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2022-06-01-preview",
              "name": "queue-worker",
              "location": "[parameters('location')]",
              "properties": {
                "managedEnvironmentId": "[parameters('containerAppsEnvironmentId')]",
                "template": {
                  "containers": [
                    {
                      "name": "dotnet-queue-worker",
                      "image": "aknagar/dotnet-queue-worker:1.0.0",
                      "resources": {
                        "cpu": "[json('0.5')]",
                        "memory": "1.0Gi"
                      },
                      "env": [
                        {
                          "name": "ASPNETCORE_ENVIRONMENT",
                          "value": "Development"
                        },
                        {
                          "name": "ASPNETCORE_URLS",
                          "value": "http://0.0.0.0:80"
                        },
                        {
                          "name": "IdentityUrl",
                          "value": "[format('https://identity-api.{0}', parameters('containerAppsEnvironmentDomain'))]"
                        },
                        {
                          "name": "IdentityUrlExternal",
                          "value": "[format('https://identity-api.{0}', parameters('containerAppsEnvironmentDomain'))]"
                        },
                        {
                          "name": "SERVICEBUS_AUTH_MODE",
                          "value": "ConnectionString"
                        },
                        {
                          "name": "SERVICEBUS_QUEUE_NAME",
                          "value": "orders"
                        },
                        {
                          "name": "SERVICEBUS_QUEUE_CONNECTIONSTRING",
                          "secretRef": "service-bus-connection-string"
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": 1,
                    "maxReplicas": 1
                  }
                },
                "configuration": {
                  "secrets": [
                    {
                      "name": "service-bus-connection-string",
                      "value": "[parameters('serviceBusConnectionString')]"
                    }
                  ]
                }
              }
            }
          ]
        }
      }
    }
  ]
}